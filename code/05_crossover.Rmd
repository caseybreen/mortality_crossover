---
title: "B-W Crossover Paper"
---

Summary: Black-White mortality crossover paper 

```{r}
## library packages 
library(tidyverse)
library(data.table)
library(here)
library(cowplot)
library(broom)
library(texreg)


## read in data 
dmf <- fread(here("data/censoc_dmf_v2.1_linked.csv")) 
```

```{r}
dmf <- dmf %>% 
  janitor::clean_names() %>% 
  mutate(race = case_when(
    race == 1 ~ "White Americans",
    race == 2 ~ "Black Americans"
  )) %>% 
  filter(link_abe_exact_conservative == 1) %>% 
  filter(bpl < 15000)

## function to camp ipums codes to years of education 
recode_education <- function(df) {
  df <- df  %>%
    mutate(educ_yrs = case_when(
      educd == 2 ~ 0,
      educd == 14 ~ 1,
      educd == 15 ~ 2,
      educd == 16 ~ 3,
      educd == 17 ~ 4,
      educd == 22 ~ 5,
      educd == 23 ~ 6,
      educd == 25 ~ 7,
      educd == 26 ~ 8,
      educd == 30 ~ 9,
      educd == 40 ~ 10,
      educd == 50 ~ 11,
      educd == 60 ~ 12,
      educd == 70 ~ 13,
      educd == 80 ~ 14,
      educd == 90 ~ 15,
      educd == 100 ~ 16,
      educd == 110 ~ 17,
      educd == 111 ~ 17,
      educd == 112 ~ 17,
      educd == 113 ~ 17
    ))
  
  return(df)
}

dmf <- dmf %>% 
  recode_education() %>% 
  filter(!is.na(educ_yrs)) %>% 
  filter(incwage %in% 0:5050) %>% 
  filter(!is.na(sei)) %>% 
  mutate(marst = as.factor(marst)) %>% 
  filter(marst != 3) %>% 
  mutate(own_home = case_when(
    ownershp == 1 ~ 1,
    TRUE ~ 0
  ),
  married = case_when(
    marst %in% 1:2 ~ 1,
    TRUE ~ 0
  ),
  employed = case_when(
   empstat == 1 ~ 1,
    TRUE ~ 0
  ),
  south = case_when(
    region %in% 31:34 ~ 1,
    TRUE ~ 0
  ))
```

```{r}
dmf_1911 <- dmf %>% 
  filter(byear %in% 1911)

model_black <- lm(death_age ~ sei + educ_yrs + incwage  + marst + empstat , data = dmf_1911 %>% filter(race == "Black Americans"))

model_white <- lm(death_age ~ sei + educ_yrs + incwage  + marst + empstat , data = dmf_1911 %>% filter(race == "White Americans"))

modeling_df_white <- dmf %>% 
  filter(race == "White Americans") %>% 
  filter(byear %in% 1909:1911) %>% 
  modelr::add_predictions(model = model_white)

modeling_df_black <- dmf %>% 
  filter(race == "Black Americans") %>% 
  filter(byear %in% 1909:1911) %>% 
  modelr::add_predictions(model = model_black)

modeling_df <- bind_rows(modeling_df_white, modeling_df_black) %>% 
  group_by(race) %>% 
  mutate(risk = 11-ntile(pred, 10))
```

```{r}
results <- list()

for (i in min(modeling_df$death_age):max(modeling_df$death_age)){
  
  ## covariate plots 
  covariates <- c("employed", "sei", "educ_yrs", "incwage", "own_home",  "south")
  cov_results_list <- list() 
  
  for (cov in covariates) {
    
    ## covariates  
    cov_results_list[[cov]] <- modeling_df %>% 
      filter(death_age >= i) %>% 
      group_by(race) %>% 
      summarize(risk_avg = mean(!!rlang::sym(cov)),
                se = sd(!!rlang::sym(cov)/ sqrt(n()))) %>% 
      mutate(death_age = i,
             covariate = cov)
  }
    
  results[[i]] <-  bind_rows(cov_results_list) 

}

risk_plot_composition <- bind_rows(results) %>% 
  mutate(covariate = case_when(
    covariate == "employed" ~ "Employed (%)",
    covariate == "own_home" ~ "Own Home (%)",
    covariate == "south" ~ "South (%)",
    covariate == "educ_yrs" ~ "Education (Yrs)",
    covariate == "sei" ~ "Socioeconomic Index",
    covariate == "incwage" ~ "Wage and Salary Income"
  )) %>% 
  filter(death_age %in% 60:92) %>% 
  ggplot(aes(x = death_age,
             y = risk_avg, 
             ymin = risk_avg - 1.96*se,
             ymax = risk_avg + 1.96*se,
             color = race,
             shape = race)) + 
  geom_line() +
  geom_pointrange() + 
  # geom_smooth(method = "lm", se= F) + 
  theme_cowplot() + 
  ggsci::scale_color_lancet() + 
  labs(x = "Age",
       y = "Risk Score",
       title = "Characteristics of the living by age ") + 
  theme(legend.position = "bottom") + 
  facet_wrap(~covariate, scales = "free", nrow =3)
 
ggsave(plot = risk_plot_composition, filename = "../figures/risk_plot_composition.png", height = 10, width = 6)
```

```{r}
educ_data <- dmf %>% 
  filter(byear %in% 1910) %>% 
  filter(death_age %in% c(0:90)) %>% 
  filter(!is.na(educ_yrs)) %>% 
  filter(!is.na(race)) %>% 
  mutate(educ_categorical = case_when(
    educ_yrs %in% 0:5 ~ "No Elementary",
    educ_yrs %in% 6:7 ~ "Elementary",
    educ_yrs %in% 8:11 ~ "Middle School",
    educ_yrs %in% 12:15 ~ "High School",
    educ_yrs %in% 16:18 ~ "College+",
  )) 

educ_data_list <- list() 

for (i in min(educ_data$death_age):max(educ_data$death_age)){
  
    ## covariates  
    educ_data_list[[i]] <- educ_data %>% 
      filter(death_age >= i) %>% 
      group_by(race, educ_categorical) %>% 
      summarize(n = n()) %>% 
      group_by(race) %>% 
      mutate(prop = n / sum(n),
             age = i)
}

education_by_age <- bind_rows(educ_data_list) %>% 
   mutate(educ_categorical = factor(educ_categorical, levels=c("College+", "High School", "Middle School", "Elementary", "No Elementary"))) %>% 
  ggplot(aes(x = age, y = prop, fill = educ_categorical)) + 
  geom_area( colour="black") + 
  scale_fill_viridis_d(alpha = 0.7) + 
  facet_wrap(~race) + 
  theme_cowplot() + 
  labs(title = "Education of the living by age") + 
      scale_y_continuous(labels = scales::percent_format(accuracy = 5L)) + 
  theme(legend.position = "bottom", legend.title = element_blank()) 

ggsave(plot = education_by_age, filename = "../figures/education_of_living.png", height = 6, width = 9)

```


```{r}
risk_data_list <- list() 

modeling_df <- modeling_df %>% 
  mutate(risk_high = case_when(
    risk >= 6 ~ "low",
    TRUE ~ "high"
  ))

for (i in min(modeling_df$death_age):max(modeling_df$death_age)){
  
    ## covariates  
    risk_data_list[[i]] <- modeling_df %>% 
      filter(death_age >= i) %>% 
      group_by(race, risk_high) %>% 
      summarize(n = n()) %>% 
      group_by(race) %>% 
      mutate(prop = n / sum(n),
             age = i) 
}

risk_by_age <- bind_rows(risk_data_list) %>% 
  filter(age < 91) %>% 
  ggplot(aes(x = age, y = prop, fill = as.factor(risk_high))) + 
  geom_area( colour="black") + 
  scale_fill_viridis_d(alpha = 0.7) + 
  facet_wrap(~race) + 
  theme_cowplot() + 
  labs(title = "Education of the living by age") + 
      scale_y_continuous(labels = scales::percent_format(accuracy = 5L)) + 
  theme(legend.position = "bottom", legend.title = element_blank()) 


risk_by_age <- bind_rows(risk_data_list) %>% 
  filter(age < 91) %>% 
  filter(risk_high == "high") %>% 
  ggplot(aes(x = age, y = prop, color = as.factor(race))) + 
  geom_point() + 
  geom_line() + 
  theme_cowplot() + 
  labs(title = "Education of the living by age") + 
  theme(legend.position = "bottom", legend.title = element_blank()) 

```

## basic regression 

```{r}
df_formodel <- dmf %>%
  filter(byear %in% 1905:1910) %>% 
  filter(incwage %in% 0:5050) %>% 
  mutate(incwage = incwage / 1000) %>% 
  mutate(own_home = case_when(ownershp == 1 ~ "own home", TRUE ~ "rent")) %>% 
  mutate(employed = case_when(empstat %in% 1 ~ "Employed", TRUE ~ "Unemployed"))

model1 <- fixest::feols(death_age ~  incwage + educ_yrs + own_home  |  statefip + byear ,
                  data = df_formodel %>% filter(race == "Black Americans"))

model2 <- fixest::feols(death_age ~ incwage + educ_yrs + own_home |  statefip + byear,
            data = df_formodel %>% filter(race == "White Americans"))

screenreg(list(model1, model2))

texreg(list(model1, model2))

```







